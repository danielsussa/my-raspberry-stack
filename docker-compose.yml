services:
  # mt5-ticker-uploader:
  #   build:
  #     context: ./services/mt5-ticker-uploader
  #   container_name: mt5-ticker-uploader
  #   restart: unless-stopped
  #   volumes:
  #     - ./.data/mt5-ticker-uploader:/data/mt5-ticker-uploader

  massive-ticker-uploader:
    build:
      context: ./services/massive-ticker-uploader
    container_name: massive-ticker-uploader
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MASSIVE_WSS_URL=wss://delayed.massive.com/stocks
      - MASSIVE_SUBSCRIBE=${MASSIVE_SUBSCRIBE:-T.EWZ}
    volumes:
      - ./.data/massive-ticker-uploader:/data/massive-ticker-uploader

  cedro-ticker-uploader:
    build:
      context: ./services/cedro-ticker-uploader
    container_name: cedro-ticker-uploader
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - CEDRO_HOST=datafeed2.cedrotech.com
      - CEDRO_PORT=81
      - CEDRO_COMMAND=${CEDRO_COMMAND:-GQT BOVA11 S}
    volumes:
      - ./.data/cedro-ticker-uploader:/data/cedro-ticker-uploader

  gen-ai-hello-notes:
    build:
      context: ./services/gen-ai-hello-notes
    container_name: gen-ai-hello-notes
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PROMPT=${GEN_AI_HELLO_NOTES_PROMPT:-Hey bot, tell me something new today.}
      - CODEX_API_KEY=${OPENAI_API_KEY}
      - CODEX_MODEL=${GEN_AI_HELLO_NOTES_MODEL:-gpt-4.1-mini}
      - OUT_FILE=/data/my-notes.md
    volumes:
      - ./:/workspace
      - ./.data/gen-ai-hello-notes:/data

  massive-news:
    build:
      context: ./services/massive-news
    container_name: massive-news
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - MASSIVE_NEWS_LIMIT=10
      - MASSIVE_NEWS_ORDER=desc
      - MASSIVE_NEWS_SORT=published_utc
      - MASSIVE_NEWS_INTERVAL_SECONDS=${MASSIVE_NEWS_INTERVAL_SECONDS:-3600}
    volumes:
      - ./.data/massive-news:/data

  market-visual-runner:
    build:
      context: ./services/market-visual-runner
    container_name: market-visual-runner
    restart: unless-stopped

  market-visual-runner-dev:
    image: node:20-alpine
    container_name: market-visual-runner-dev
    working_dir: /app
    restart: unless-stopped
    volumes:
      - ./services/market-visual-runner:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"

  market-visual-runner-bff:
    build:
      context: ./services/market-visual-runner-bff
    container_name: market-visual-runner-bff
    restart: unless-stopped
    volumes:
      - ./.data/cedro-ticker-uploader:/data/cedro-ticker-uploader:ro
      - ./.data/massive-ticker-uploader:/data/massive-ticker-uploader:ro

  intraday-ai-predict:
    build:
      context: ./services/intraday-ai-predict
    container_name: intraday-ai-predict
    restart: "no"
    env_file:
      - .env
    environment:
      INTRADAY_AI_PREDICT_PROMPT_FILE: "/data/intraday-ai-predict/AI_README.md"
      INTRADAY_AI_PREDICT_PROMPT: "${INTRADAY_AI_PREDICT_PROMPT:-}"
      CODEX_API_KEY: "${OPENAI_API_KEY}"
      INTRADAY_AI_PREDICT_MODEL: "${INTRADAY_AI_PREDICT_MODEL:-}"
      INTRADAY_AI_PREDICT_MODE: "${INTRADAY_AI_PREDICT_MODE:-full-auto}"
      INTRADAY_AI_PREDICT_CLEAR_ON_START: "${INTRADAY_AI_PREDICT_CLEAR_ON_START:-1}"
      INTRADAY_AI_PREDICT_DATA_ROOT: "/data/intraday-ai-predict"
      INTRADAY_AI_PREDICT_INTERVAL_SECONDS: "${INTRADAY_AI_PREDICT_INTERVAL_SECONDS:-3600}"
      INTRADAY_AI_PREDICT_WORKSPACE: "/data/intraday-ai-predict/workspace"
      INTRADAY_AI_PREDICT_OUT_FILE: "/data/intraday-ai-predict/predictions.md"
      INTRADAY_AI_PREDICT_STOP_TOKEN: "${INTRADAY_AI_PREDICT_STOP_TOKEN:-END_SESSION}"
    volumes:
      - ./.data/intraday-ai-predict:/data/intraday-ai-predict
      - ./services/intraday-ai-predict/AI_README.md:/data/intraday-ai-predict/AI_README.md:ro

  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro

  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok
    restart: unless-stopped
    env_file:
      - .env
    command: ["start", "--all", "--config", "/etc/ngrok/ngrok.yml"]
    ports:
      - "4040:4040"
    volumes:
      - ./config/ngrok/ngrok.yml:/etc/ngrok/ngrok.yml:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"

  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SERVER_DOMAIN=ivanna-unwhispering-histologically.ngrok-free.dev
      - GF_SERVER_ROOT_URL=https://ivanna-unwhispering-histologically.ngrok-free.dev/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - ./.data/grafana:/var/lib/grafana

  # nsqlookupd:
  #   image: nsqio/nsq:latest
  #   container_name: nsqlookupd
  #   restart: unless-stopped
  #   command: /nsqlookupd
  #   ports:
  #     - "4160:4160"
  #     - "4161:4161"

  # nsqd:
  #   image: nsqio/nsq:latest
  #   container_name: nsqd
  #   restart: unless-stopped
  #   command: /nsqd --lookupd-tcp-address=nsqlookupd:4160
  #   depends_on:
  #     - nsqlookupd
  #   ports:
  #     - "4150:4150"
  #     - "4151:4151"

  # nsqadmin:
  #   image: nsqio/nsq:latest
  #   container_name: nsqadmin
  #   restart: unless-stopped
  #   command: /nsqadmin --lookupd-http-address=nsqlookupd:4161
  #   depends_on:
  #     - nsqlookupd
  #   ports:
  #     - "4171:4171"

  # n8n:
  #   image: n8nio/n8n:latest
  #   container_name: n8n
  #   restart: unless-stopped
  #   env_file:
  #     - .env
  #   ports:
  #     - "5678:5678"
  #   volumes:
  #     - ./.data/n8n:/home/node/.n8n
